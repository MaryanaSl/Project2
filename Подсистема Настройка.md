### Настройка

1. Добавлено перечисление **ТипыНоменклатуры** со значениями Товар и Услуга.
  
2. Добавлено перечисление **СтавкиНДС** со значениями БезНДС ("Без НДС"), НДС10 ("10%"), НДС20 ("20%").

3. Добавлен справочник **НоменклатурныеГруппы**:

4. Добавлен справочник **Номенклатура** - иерархичный, с необходимыми реквизитами и "Проверкой заполнения" в обязательных полях

  * В модуле объекта переопределено событие ОбработкаЗаполнения, заполнив тип и ставку НДС значениями по умолчанию (Товар, НДС20). Заполняется только для элемента (для группы эти реквизиты не определены).
  * Создана форма элемента:
 

5. Добавлен регистр сведений **Цены** - режим записи "Подчинение регистратору" и периодичность "По позиции регистратора", измерение Номенклатура (СправочникСсылка.Номенклатура) с флагом "Ведущее" и ресурс Цена (ОпределяемыйТип.Сумма)
  * Для роли "Базовые права" - права на просмотр и чтение, для роли "Полные права" - права на добавление, изменение и запись.
  * Добавлен общий модуль ЦеныСервер с флажком "Сервер", и создана экспортная функция ЦенаНаДату(Номенклатура, Дата), которая получает запросом срез последних на указанную дату с отбором по номенклатуре и возвращает цену.


<details>
	
 <summary><u>Функция ЦенаНаДату в ОМ ЦеныСервер</u></summary>

```bsl
Функция ЦенаНаДату (Номенклатура, Дата) Экспорт
	
	//получить запросом срез последних на указанную дату с отбором по номенклатуре и вернет цену. 
	Запрос = Новый Запрос;
	Запрос.Текст = 
			"   ВЫБРАТЬ
			|	ЦеныСрезПоследних.Номенклатура КАК Номенклатура,
			|	МАКСИМУМ(ЦеныСрезПоследних.Период) КАК Период
			|ПОМЕСТИТЬ ВТ_номенклатурыБезЦены
			|ИЗ
			|	РегистрСведений.Цены.СрезПоследних (КОНЕЦПЕРИОДА(&Период, ДЕНЬ), ) КАК ЦеныСрезПоследних
			|ГДЕ
			|	ЦеныСрезПоследних.Номенклатура = &Номенклатура
			|
			|СГРУППИРОВАТЬ ПО
			|	ЦеныСрезПоследних.Номенклатура
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	МАКСИМУМ(ЦеныСрезПоследних.Цена) КАК Цена,
			|	МАКСИМУМ(ЦеныСрезПоследних.Период) КАК Период,
			|	ЦеныСрезПоследних.Номенклатура КАК Номенклатура
			|ИЗ
			|	ВТ_номенклатурыБезЦены КАК ВТ_номенклатурыБезЦены
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.Цены.СрезПоследних КАК ЦеныСрезПоследних
			|		ПО ВТ_номенклатурыБезЦены.Номенклатура = ЦеныСрезПоследних.Номенклатура
			|			И ВТ_номенклатурыБезЦены.Период = ЦеныСрезПоследних.Период
			|
			|СГРУППИРОВАТЬ ПО
			|	ЦеныСрезПоследних.Номенклатура";

	Запрос.УстановитьПараметр("Период", Дата);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	
	Выборка = Запрос.Выполнить().Выбрать(); 
	
	Пока Выборка.Следующий() Цикл
		Цена = Выборка.Цена;
	КонецЦикла;
	
	Возврат Цена;
	
КонецФункции
```
</details>

  * Добавлен общий модуль ЦеныВызовСервера с флажками "Сервер", "Внешнее соединение" и "Вызов сервера", и создана в нем функция ЦенаНаДату для вызова из клиентского кода форм, которая вызовет одноименную функцию из модуля ЦеныСервер (вызывается в процедуре ПриИзмененииНоменклатуры с целью заполнения актуальной ценой).

<details>
	
 <summary><u>Функция ЦенаНаДату в ОМ ЦеныВызовСервера</u></summary>

```bsl
Функция ЦенаНаДату (Номенклатура, Дата) Экспорт
	
	Возврат ЦеныСервер.ЦенаНаДату(Номенклатура, Дата);
	
КонецФункции
```
</details>

6. Добавлен документ **УстановкаЦен**:
  * Добавлена ТЧ Цены с реквизитами Номенклатура (СправочникСсылка.Номенклатура) и Цена (ОпределяемыйТип.Сумма)
  * В "Движениях" выбран регистр сведений "Цены"
  * Роли "Базовые права" даны права на просмотр и чтение, роли "Полные права" - на добавление, изменение и запись.
  * В модуле объекта:
    * Переопределлено событие ОбработкаПроведения, формируя движения по регистру сведений Цены датой документа
  * Создана форма документа, в которой:
    * Создана клиентская процедура ПриИзмененииНоменклатуры с параметром ИзмененнаяСтрока (ДанныеФормыЭлементКоллекции), в которой, если Номенклатура заполнена, вызвается ЦеныВызовСервера.ЦенаНаДату и заполнняется цена.
    * Переопределено событие ПриИзменении поля ввода номенклатуры и вызывается в нем процедура ПриИзмененииНоменклатуры с передачей текущих данных таблицы цен.
    * Добавлена команда Подбор. В обработчике команды открывается форма выбора справочника Номенклатура с параметром ЗакрыватьПриВыборе = Ложь, указывается в качестве владельца таблица цен.
    * Переопределено событие ОбработкаВыбора таблицы цен. Если в таблице еще нет выбранного значения - добавить строку и вызвать процедуру ПриИзмененииНоменклатуры, передав добавленную строку.

<details>
	
 <summary><u>Код модуля формы документа Установка Цен</u></summary>
   
  ```bsl
&НаКлиенте
Процедура ЦеныНоменклатураПриИзменении(Элемент)
	// Переопределить событие ПриИзменении поля ввода номенклатуры и 
	//вызвать в нем процедуру ПриИзмененииНоменклатуры с передачей текущих данных таблицы цен  
	
	ТекДанные = Элементы.Цены.ТекущиеДанные;
    ПриИзмененииНоменклатуры (ТекДанные);
	
КонецПроцедуры


&НаКлиенте
Процедура ПриИзмененииНоменклатуры (ИзмененнаяСтрока)
	//Создать клиентскую процедуру ПриИзмененииНоменклатуры с параметром ИзмененнаяСтрока 
	//(ДанныеФормыЭлементКоллекции), в которой, если Номенклатура заполнена, 
	//вызвать ЦеныВызовСервера.ЦенаНаДату и заполнить цену
	
	Если ЗначениеЗаполнено(ИзмененнаяСтрока.Номенклатура) Тогда
		ИзмененнаяСтрока.Цена = ЦеныВызовСервера.ЦенаНаДату(ИзмененнаяСтрока.Номенклатура, Объект.Дата);
	КонецЕсли;  
	
		
КонецПроцедуры

&НаКлиенте
Процедура Подбор(Команда)
	// Добавить команду Подбор, разместив ее в командной панели таблицы цен. 
	//В обработчике команды открыть форму выбора справочника Номенклатура 
	//с параметром ЗакрыватьПриВыборе = Ложь, указав в качестве владельца таблицу цен.

    ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("ВыборГруппИЭлементов", ИспользованиеГруппИЭлементов.ГруппыИЭлементы);
	ПараметрыФормы.Вставить("ЗакрыватьПриВыборе", Ложь);
	ОткрытьФорму("Справочник.Номенклатура.ФормаВыбора", ПараметрыФормы, Элементы.Цены);

КонецПроцедуры

&НаКлиенте
Процедура ЦеныОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	//Переопределить событие ОбработкаВыбора таблицы цен. 
	//В обработчике отказаться от стандартной обработки и, 
	//если в таблице еще нет выбранного значения - добавить строку и 
	//вызвать процедуру ПриИзмененииНоменклатуры, передав добавленную строку.  
	СтандартнаяОбработка = Ложь;
	
	// Выполним поиск в таблице строки с этой номенклатурой;
	ОтборСтрок = Новый Структура ("Номенклатура", ВыбранноеЗначение);
	НайденныеСтрокиВСпискеВыбранных = Объект.Цены.НайтиСтроки(ОтборСтрок);
	
	
	//Если строка не найдена - создадим новую строку, в колонку 
	//Номенклатура укажем выбранное значение, 	
	Если НайденныеСтрокиВСпискеВыбранных.Количество() = 0 Тогда
		
		НоваяСтрокаТаблицы = Объект.Цены.Добавить();
		НоваяСтрокаТаблицы.Номенклатура = ВыбранноеЗначение;     
		ПриИзмененииНоменклатуры(НоваяСтрокаТаблицы);
		
	Иначе 
		Возврат;
	КонецЕсли;
	
КонецПроцедуры
```
</details>


* Форма выглядит так:

![image](https://github.com/user-attachments/assets/141e1bd8-1711-49fb-8360-a2062282a12b)

  * В итоге в документе **УстановкаЦен**:
    * Введенные цены после проведения появляются в регистре.
    * Выбор и подбор номенклатуры в последующих документах автоматически подставляют цены из предыдущих документов.

![image](https://github.com/user-attachments/assets/fbce9829-b217-4ac1-a04a-d3624351b556)


7. Добавлен регистр сведений **Скидки** с режим записи "Подчинение регистратору" и периодичностью "По позиции регистратора"
  * Добавлено измерение НоменклатураНоменклатурнаяГруппа (СправочникСсылка.Номенклатура, СправочникСсылка.НоменклатурныеГруппы) с флагом "Ведущее" и ресурсом Скидка (Число)
   * В общий модуль ЦеныСервер добавлена экспортная функция СкидкаНаДату(Номенклатура, Дата), которая получает запросом срез последних на указанную дату с отбором по номенклатуре и номенклатурной группе и возвращает скидку, установленную для номенклатурной группы, если нет скидки для конкретной номенклатуры. В общий модуль ЦеныВызовСервера добавлена одноименная функция-обертка.

<details>
	
 <summary><u>Общий модуль ЦеныВызовСервера (вызывается в процедуре ПриИзмененииНоменклатурыНоменклатурнойГруппы с целью заполнения актуальной скидкой </u></summary>

```bsl
Функция СкидкаНаДату (Номенклатура, Дата) Экспорт
	//В общий модуль ЦеныВызовСервера добавить одноименную функцию-обертку
	Возврат ЦеныСервер.СкидкаНаДату(Номенклатура, Дата);
	
КонецФункции
   ```
</details>

<details>
	
 <summary><u>Общий модуль ЦеныСервер</u></summary>

```bsl
Функция СкидкаНаДату (Номенклатура, Дата) Экспорт
	
	//получить запросом срез последних на указанную дату с отбором по номенклатуре 
	//и номенклатурной группе и вернет скидку, установленную для номенклатурной группы, 
	//если нет скидки для конкретной номенклатуры.   
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
			"ВЫБРАТЬ
			|	СкидкиСрезПоследних.НоменклатураНоменклатурнаяГруппа.Ссылка КАК НоменклатураНоменклатурнаяГруппа,
			|	СкидкиСрезПоследних.Скидка КАК Скидка,
			|	0 КАК Приоритет
			|ПОМЕСТИТЬ ВременнаяТаблица_Скидки
			|ИЗ
			|	РегистрСведений.Скидки.СрезПоследних(КОНЕЦПЕРИОДА(&Период, ДЕНЬ), НоменклатураНоменклатурнаяГруппа = &Номенклатура) КАК СкидкиСрезПоследних
			|
			|ОБЪЕДИНИТЬ
			|
			|ВЫБРАТЬ
			|	СкидкиСрезПоследних.НоменклатураНоменклатурнаяГруппа.НоменклатурнаяГруппа,
			|	СкидкиСрезПоследних.Скидка,
			|	1
			|ИЗ
			|	РегистрСведений.Скидки.СрезПоследних(КОНЕЦПЕРИОДА(&Период, ДЕНЬ), НоменклатураНоменклатурнаяГруппа = &НоменклатурнаяГруппа) КАК СкидкиСрезПоследних
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ ПЕРВЫЕ 1
			|	ВременнаяТаблица_Скидки.НоменклатураНоменклатурнаяГруппа.Ссылка КАК НоменклатураНоменклатурнаяГруппаСсылка,
			|	ВременнаяТаблица_Скидки.Скидка КАК Скидка,
			|	ВременнаяТаблица_Скидки.Приоритет КАК Приоритет
			|ИЗ
			|	ВременнаяТаблица_Скидки КАК ВременнаяТаблица_Скидки
			|
			|УПОРЯДОЧИТЬ ПО
			|	Приоритет ВОЗР";

	Запрос.УстановитьПараметр("Период", Дата);
	Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
	Если ТипЗнч(Номенклатура) <> Тип("СправочникСсылка.НоменклатурныеГруппы") Тогда
		Запрос.УстановитьПараметр("НоменклатурнаяГруппа", Номенклатура.НоменклатурнаяГруппа);
	Иначе
		Запрос.УстановитьПараметр("НоменклатурнаяГруппа", Номенклатура);
	КонецЕсли;
	
	Выборка = Запрос.Выполнить().Выбрать(); 
	
	Пока Выборка.Следующий() Цикл
		Скидка = Выборка.Скидка;
	КонецЦикла;
	
	Возврат Скидка;
	
КонецФункции

```
</details>


8. Добавлен документ **УстановкаСкидок** :
  * Добавлена ТЧ Скидки с реквизитами НоменклатураНоменклатурнаяГруппа (СправочникСсылка.Номенклатура, СправочникСсылка.НоменклатурныеГруппы) и Скидка (Число)
  * В "Движениях" выбран регистр сведений "Скидки"
  * Роли "Базовые права" даны права на просмотр и чтение, роли "Полные права" - на добавление, изменение и запись.
  * В модуле объекта:
    * Переопределено событие ОбработкаПроведения, формируя движения по регистру сведений Скидки датой документа
  * Создана форма документа, в которой:
    * Создана клиентская процедура ПриИзмененииНоменклатурыНоменклатурнойГруппы с параметром ИзмененнаяСтрока (ДанныеФормыЭлементКоллекции), в которой, если НоменклатураНоменклатурнаяГруппа заполнена, вызывается ЦеныВызовСервера.СкидкаНаДату и заполняется скидка.
    * Переопределено событие ПриИзменении поля ввода номенклатуры / номенклатурной группы и вызывается процедура ПриИзмененииНоменклатурыНоменклатурнойГруппы с передачей текущих данных таблицы скидок.


<details>
	
 <summary><u>Код модуля формы документа Установка Скидок</u></summary>
   
```bsl
 &НаКлиенте
Процедура ПриИзмененииНоменклатурыНоменклатурнойГруппы (ИзмененнаяСтрока)
	//	Создать клиентскую процедуру ПриИзмененииНоменклатурыНоменклатурнойГруппы 
	//с параметром ИзмененнаяСтрока (ДанныеФормыЭлементКоллекции), 
	//в которой, если НоменклатураНоменклатурнаяГруппа заполнена, 
	//вызвать ЦеныВызовСервера.СкидкаНаДату и заполнить скидку.
	
	Если ЗначениеЗаполнено(ИзмененнаяСтрока.НоменклатураНоменклатурнаяГруппа) Тогда
		ИзмененнаяСтрока.Скидка = ЦеныВызовСервера.СкидкаНаДату(ИзмененнаяСтрока.НоменклатураНоменклатурнаяГруппа, Объект.Дата);
	КонецЕсли;  
		
КонецПроцедуры


&НаКлиенте
Процедура СкидкиНоменклатураНоменклатурнаяГруппаПриИзменении(Элемент)
	//Переопределить событие ПриИзменении поля ввода номенклатуры / номенклатурной группы 
	//и вызвать в нем процедуру ПриИзмененииНоменклатурыНоменклатурнойГруппы 
	//с передачей текущих данных таблицы скидок.     
	
	ТекДанные = Элементы.Скидки.ТекущиеДанные;
	ПриИзмененииНоменклатурыНоменклатурнойГруппы (ТекДанные);
	
КонецПроцедуры
```
</details>

* Форма выглядит так:

![image](https://github.com/user-attachments/assets/143c778a-7976-4592-85c5-8f4be180cdfd)

  * В результате в документе Установка Скидок:
    * Введенные скидки после проведения появляются в регистре.
    * Выбор в последующих документах автоматически подставляет скидки из предыдущих.
    
9. Добавлен журнал документов **ЦеныИСкидки**:
  * В качестве регистрируемых выбраны документы **УстановкаЦен** и **УстановкаСкидок**
  * Добавлена графа Ответственный 

![image](https://github.com/user-attachments/assets/9cd40882-94c9-4f67-bfb4-1067c0eec84f)
